{%- comment -%}
  Snippet: Collection Grid
  Purpose: Product grid display with pagination for collection/search pages

  Parameters:
    - is_search: Boolean indicating if this is a search results page
    - collection: Collection object (for collection pages)
    - search: Search object (for search pages)
    - search_performed: Boolean indicating if search was performed
    - products_per_page: Number of products to show per page
    - grid_classes: CSS classes for grid layout
    - section_id: Section ID for unique identifiers
    - settings: Section settings object
{%- endcomment -%}

{%- liquid
  assign is_search = is_search | default: false
  assign products_per_page = products_per_page | default: 24

  # Determine if we should show products
  assign show_products = false
  if is_search
    if search_performed and search.results_count > 0
      assign show_products = true
    endif
  elsif collection.products.size > 0
    assign show_products = true
  endif
-%}

{%- if is_search -%}
  {%- # Search context handling -%}
  {%- if show_products -%}
    {%- # Search results with products -%}
    {%- paginate search.results by products_per_page -%}
      <div
        class="{{ grid_classes }}"
        data-product-grid
        role="region"
        aria-label="{{ 'templates.search.results' | t }}"
      >
        {%- for item in search.results -%}
          {%- case item.object_type -%}
            {%- when 'product' -%}
              <div class="collection-grid__item" data-product-grid-item>
                {% render 'snippet-feature-product-card', product: item %}
              </div>
          {%- endcase -%}
        {%- endfor -%}
      </div>

      {%- # Search Pagination -%}
      {%- if paginate.pages > 1 -%}
        <div
          class="collection-page__pagination search-results__pagination"
          role="navigation"
          aria-label="{{ 'general.pagination.label' | t }}"
        >
          {%- if paginate.previous -%}
            <a href="{{ paginate.previous.url }}" class="pagination__item pagination__item--prev">
              {{ 'general.pagination.previous' | t }}
            </a>
          {%- endif -%}

          <span class="pagination__current">
            {{ 'general.pagination.page' | t: current: paginate.current_page, total: paginate.pages }}
          </span>

          {%- if paginate.next -%}
            <a href="{{ paginate.next.url }}" class="pagination__item pagination__item--next">
              {{ 'general.pagination.next' | t }}
            </a>
          {%- endif -%}
        </div>
      {%- endif -%}
    {%- endpaginate -%}
  {%- elsif search_performed -%}
    {%- # No search results state -%}
    <div class="collection-page__empty search-results__empty">
      <h2>{{ 'templates.search.no_results_title' | t }}</h2>
      <p>{{ 'templates.search.no_results_text' | t: terms: search.terms }}</p>
      <a href="{{ routes.all_products_collection_url }}" class="button">
        {{ 'page-specific.collections.continue_shopping' | t }}
      </a>
    </div>
  {%- else -%}
    {%- # Search form for empty search -%}
    <div class="collection-page__empty search-results__form">
      <form action="{{ routes.search_url }}" method="get" role="search">
        <div class="search-form__field">
          <label for="search-input" class="visually-hidden">{{ 'global.drawer-group.search.search' | t }}</label>
          <input
            type="search"
            id="search-input"
            name="q"
            placeholder="{{ 'global.drawer-group.search.placeholder' | t }}"
            class="search-form__input"
            value="{{ search.terms | escape }}"
          >
          <button type="submit" class="search-form__submit">
            <span class="icon icon-search"></span>
            <span class="visually-hidden">{{ 'global.drawer-group.search.submit' | t }}</span>
          </button>
        </div>
      </form>
    </div>
  {%- endif -%}
{%- else -%}
  {%- # Collection context handling -%}
  {%- if show_products -%}
    {%- # Filters are handled by Shopify automatically when configured in admin -%}

    {%- # Shopify automatically applies filters from URL parameters to collection.products -%}
    {%- # No additional filtering logic needed - collection.products is already filtered -%}
    {%- liquid
      # Check if we have active filters for debugging
      assign has_active_filters = false
      for filter in collection.filters
        if filter.active_values.size > 0
          assign has_active_filters = true
          break
        endif
      endfor
    -%}

    {%- # Standard Shopify Pagination (collection.products is already filtered by URL params) -%}
    {%- paginate collection.products by products_per_page -%}
      <div
        class="{{ grid_classes }}"
        data-product-grid
        role="region"
        aria-label="{{ 'page-specific.collections.product_grid' | t }}"
        data-products-per-page="{{ products_per_page }}"
        data-current-page="{{ paginate.current_page }}"
        data-total-pages="{{ paginate.pages }}"
      >
        {%- # Render products for current page -%}
        {%- for product in collection.products -%}
          <div class="collection-grid__item" data-product-grid-item data-product-id="{{ product.id }}">
            {% render 'snippet-feature-product-card', product: product %}
          </div>
        {%- endfor -%}
      </div>

      {%- # Modern Pagination Controls -%}
      {%- if paginate.pages > 1 -%}
        <nav
          class="pagination pagination--modern"
          data-pagination
          role="navigation"
          aria-label="{{ 'page-specific.collections.pagination_label' | t }}"
        >
          {%- # Navigation controls wrapper -%}
          <div class="pagination__controls">
            {%- # Previous button -%}
            <a
              href="{{ paginate.previous.url | default: '#' }}"
              class="pagination__nav pagination__nav--prev {% unless paginate.previous %}pagination__nav--disabled{% endunless %}"
              data-pagination-prev
              aria-label="{{ 'general.pagination.previous' | t }}"
              {% unless paginate.previous %}aria-disabled="true" tabindex="-1"{% endunless %}
            >
              <svg class="pagination__arrow" width="8" height="12" viewBox="0 0 8 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 1L2 6L7 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </a>

            {%- # Page numbers container -%}
            <div class="pagination__numbers" aria-label="Page numbers">
              {%- for part in paginate.parts -%}
                {%- if part.is_link -%}
                  <a
                    href="{{ part.url }}"
                    class="pagination__number"
                    aria-label="{{ 'general.pagination.page' | t: number: part.title }}"
                  >
                    {{ part.title }}
                  </a>
                {%- else -%}
                  {%- if part.title == paginate.current_page -%}
                    <span
                      class="pagination__number pagination__number--current"
                      aria-current="page"
                    >
                      {{ part.title }}
                    </span>
                  {%- elsif part.title == '&hellip;' -%}
                    <span class="pagination__dots" aria-label="More pages">
                      <svg width="20" height="4" viewBox="0 0 20 4" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="2" cy="2" r="1.5" fill="currentColor" opacity="0.3"/>
                        <circle cx="10" cy="2" r="1.5" fill="currentColor" opacity="0.3"/>
                        <circle cx="18" cy="2" r="1.5" fill="currentColor" opacity="0.3"/>
                      </svg>
                    </span>
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            </div>

            {%- # Next button -%}
            <a
              href="{{ paginate.next.url | default: '#' }}"
              class="pagination__nav pagination__nav--next {% unless paginate.next %}pagination__nav--disabled{% endunless %}"
              data-pagination-next
              aria-label="{{ 'general.pagination.next' | t }}"
              {% unless paginate.next %}aria-disabled="true" tabindex="-1"{% endunless %}
            >
              <svg class="pagination__arrow" width="8" height="12" viewBox="0 0 8 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L6 6L1 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </a>
          </div>

          {%- # Subtle pagination info -%}
          <div
            class="pagination__info"
            data-pagination-info
            id="pagination-info-{{ section_id }}"
            aria-live="polite"
          >
            {%- liquid
              assign first_product = paginate.current_offset | plus: 1
              assign products_on_page = collection.products.size
              assign last_product = paginate.current_offset | plus: products_on_page
              assign total_products = paginate.items
            -%}
            <span class="pagination__info-text">
              {{ first_product }}â€“{{ last_product }} of {{ total_products }}
            </span>
          </div>
        </nav>
      {%- endif -%}
    {%- endpaginate -%}
  {%- else -%}
    {%- # Empty collection state -%}
    <div class="collection-page__empty">
      <h2 style="font-size: 1.5em; margin-bottom: 1rem;">{{ 'page-specific.collections.no_products_title' | t }}</h2>
      <p style="margin-bottom: 2rem;">{{ 'page-specific.collections.no_products_text' | t }}</p>
      
      {%- # Check if we have active filters to show reset button -%}
      {%- liquid
        assign has_active_filters = false
        if collection and collection.filters
          for filter in collection.filters
            for filter_value in filter.values
              if filter_value.active
                assign has_active_filters = true
                break
              endif
            endfor
            if has_active_filters
              break
            endif
          endfor
        endif
      -%}

      <div class="collection-page__empty-actions">
        {%- assign continue_shopping_text = 'page-specific.collections.continue_shopping' | t -%}
        {% render 'snippet-feature-button', 
           button_text: continue_shopping_text,
           button_link: routes.root_url,
           style_wrapper: 'flat-basic' %}
        
        {%- if has_active_filters -%}
          {%- assign clear_all_url = collection.url | append: '?sort_by=' | append: collection.sort_by -%}
          {%- assign clear_filters_text = 'page-specific.collections.clear_all_filters' | t -%}
          {% render 'snippet-feature-button', 
             button_text: clear_filters_text,
             button_link: clear_all_url,
             style_wrapper: 'flat-basic',
             custom_tag: 'data-filter-clear-all' %}
        {%- endif -%}
      </div>
    </div>
  {%- endif -%}
{%- endif -%}

{%- # No results state (hidden by default) -%}
<div class="collection-page__no-results" data-no-results style="display: none;" role="status" aria-live="polite">
  <h2>
    {% if settings.custom_empty_message and settings.custom_empty_message != blank -%}
      {{- settings.custom_empty_message -}}
    {%- else -%}
      {{- 'page-specific.collections.no_results_title' | t -}}
    {%- endif %}
  </h2>
  <p>{{ 'page-specific.collections.no_results_text' | t }}</p>
  <button class="button" data-clear-filters type="button" aria-describedby="no-results-help">
    {{ 'page-specific.collections.clear_all_filters' | t }}
  </button>
  <div id="no-results-help" class="visually-hidden">
    {{ 'page-specific.collections.clear_filters_help' | t }}
  </div>
</div>
