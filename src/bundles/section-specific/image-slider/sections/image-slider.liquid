{% comment %} sections/slider-section.liquid – updated for configurable gaps, side‑effects & optional BG pattern {% endcomment %}

{%- comment -%} Assets loaded conditionally via theme.liquid {%- endcomment -%}

{%- liquid
  assign slide_gap = section.settings.slide_gap | default: 16
  assign section_padding = section.settings.section_padding | default: 32
  assign blur_amount = section.settings.blur_amount | default: 4
  assign side_opacity = section.settings.side_opacity | default: 0.6
  assign side_scale = section.settings.side_scale | default: 0.8
  assign bg_img = section.settings.background_image
  assign bg_opacity = section.settings.background_opacity | default: 0
  assign bg_size = section.settings.background_tile_size | default: 150
  
  comment
    Performance optimization: Preload the first slide image for faster LCP
  endcomment
  assign first_slide = section.blocks.first
  if first_slide.settings.image != blank
    assign preload_url_desktop = first_slide.settings.image | image_url: width: 1920
    assign preload_url_mobile = first_slide.settings.image | image_url: width: 768
    echo '<link rel="preload" as="image" href="' | append: preload_url_desktop | append: '" media="(min-width: 768px)">'
    echo '<link rel="preload" as="image" href="' | append: preload_url_mobile | append: '" media="(max-width: 767px)">'
  endif
-%}

<section
  class="image-slider"
  aria-label="Image slider with {{ section.blocks.size }} slides"
  aria-roledescription="carousel"
  data-section-type="image-slider"
  data-autoplay="{{ section.settings.enable_autoplay }}"
  data-interval="{{ section.settings.autoplay_interval | times: 1000 }}"
  style="
    --slider-transition-duration: {{ section.settings.transition_duration }}ms;
    --slider-slide-spacing: {{ slide_gap }}px;
    --slider-section-padding: {{ section_padding }}px;
    --slider-slide-blur: {{ blur_amount }}px;
    --slider-slide-opacity: {{ side_opacity }};
    --slider-slide-scale: {{ side_scale }};
    {%- if bg_img != blank -%}
      {%- comment -%} Background pattern optimized for tiling - higher resolution for crisp patterns {%- endcomment -%}
      --slider-background-image: url({{ bg_img | image_url: width: 800 }});
      --slider-background-opacity: {{ bg_opacity }};
      --slider-background-tile-size: {{ bg_size }}px;
    {%- endif -%}
  "
>
  <div class="image-slider__arrows">
    {%- render 'snippet-feature-arrow-navigation',
      data_attributes: 'data-arrow="prev"',
      direction: 'prev',
      style_wrapper: 'glassmorphism',
      position: 'overlay'
    -%}
    {%- render 'snippet-feature-arrow-navigation',
      data_attributes: 'data-arrow="next"',
      direction: 'next',
      style_wrapper: 'glassmorphism',
      position: 'overlay'
    -%}
  </div>

  <div class="image-slider__container" style="opacity: 0; transition: opacity 0.3s ease;">
    {% for block in section.blocks %}
      {% comment %} Render each slide with proper ARIA attributes {% endcomment %}
      <div 
        class="image-slider__slide" 
        {{ block.shopify_attributes }}
        {% if forloop.first %}aria-current="true"{% endif %}
        aria-hidden="{% unless forloop.first %}true{% else %}false{% endunless %}"
        aria-label="Slide {{ forloop.index }} of {{ forloop.length }}"
      >
        {% if block.settings.image %}
          {%- comment -%} Optimized responsive images with modern format support and comprehensive widths {%- endcomment -%}
          {%- liquid
            assign is_first_slide = forloop.first
            assign loading_strategy = 'lazy'
            if is_first_slide
              assign loading_strategy = 'eager'
            endif
          -%}
          <picture class="image-slider__picture">
            {%- comment -%} WebP format for modern browsers {%- endcomment -%}
            <source
              type="image/webp"
              srcset="
                {{ block.settings.image | image_url: width: 320, format: 'webp' }} 320w,
                {{ block.settings.image | image_url: width: 480, format: 'webp' }} 480w,
                {{ block.settings.image | image_url: width: 640, format: 'webp' }} 640w,
                {{ block.settings.image | image_url: width: 768, format: 'webp' }} 768w,
                {{ block.settings.image | image_url: width: 1024, format: 'webp' }} 1024w,
                {{ block.settings.image | image_url: width: 1280, format: 'webp' }} 1280w,
                {{ block.settings.image | image_url: width: 1536, format: 'webp' }} 1536w,
                {{ block.settings.image | image_url: width: 1920, format: 'webp' }} 1920w,
                {{ block.settings.image | image_url: width: 2400, format: 'webp' }} 2400w,
                {{ block.settings.image | image_url: width: 2900, format: 'webp' }} 2900w"
              sizes="(max-width: 767px) 100vw, (max-width: 1279px) 90vw, 1450px">
            {%- comment -%} Fallback JPEG/PNG for older browsers {%- endcomment -%}
            {%- if is_first_slide -%}
              {{
                block.settings.image
                | image_url: width: 2900
                | image_tag: 
                  loading: loading_strategy,
                  widths: '320, 480, 640, 768, 1024, 1280, 1536, 1920, 2400, 2900',
                  sizes: '(max-width: 767px) 100vw, (max-width: 1279px) 90vw, 1450px',
                  class: 'image-slider__image',
                  fetchpriority: 'high'
              }}
            {%- else -%}
              {{
                block.settings.image
                | image_url: width: 2900
                | image_tag: 
                  loading: loading_strategy,
                  widths: '320, 480, 640, 768, 1024, 1280, 1536, 1920, 2400, 2900',
                  sizes: '(max-width: 767px) 100vw, (max-width: 1279px) 90vw, 1450px',
                  class: 'image-slider__image',
                  fetchpriority: 'auto'
              }}
            {%- endif -%}
          </picture>
        {% else %}
          <div class="placeholder-slide">
            {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {% endif %}
        {% render 'snippet-section-image-slider-slide', block: block %}
      </div>
    {% endfor %}
  </div>
</section>

{%- comment -%} JavaScript loaded conditionally via theme.liquid {%- endcomment -%}

{% schema %}
{
  "name": "Image Slider",
  "tag": "section",
  "class": "shopify-section--slider",
  "max_blocks": 10,
  "settings": [
    {
      "type": "header",
      "content": "Slider Behavior"
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_interval",
      "label": "Autoplay interval (seconds)",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 10
    },
    {
      "type": "range",
      "id": "transition_duration",
      "label": "Transition duration (ms)",
      "min": 100,
      "max": 3000,
      "step": 50,
      "default": 1000
    },

    /* --------  New Appearance group  -------- */
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "range",
      "id": "slide_gap",
      "label": "Gap between slides (px)",
      "min": 0,
      "max": 64,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "section_padding",
      "label": "Padding above & below slider (px)",
      "min": 0,
      "max": 160,
      "step": 4,
      "default": 32
    },
    {
      "type": "range",
      "id": "blur_amount",
      "label": "Side‑slide blur (px)",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "side_opacity",
      "label": "Side‑slide opacity (0 – 1)",
      "min": 0.1,
      "max": 1,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "side_scale",
      "label": "Side‑slide scale (0.5 – 1)",
      "min": 0.5,
      "max": 1,
      "step": 0.1,
      "default": 0.8
    },
    /* ---------- Background ---------- */
    {
      "type": "header",
      "content": "Background Pattern"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background tile image"
    },
    {
      "type": "range",
      "id": "background_opacity",
      "label": "Background opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0.1
    },
    {
      "type": "range",
      "id": "background_tile_size",
      "label": "Background tile size (px)",
      "min": 50,
      "max": 500,
      "step": 10,
      "default": 150
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Slide Image" },
        { "type": "text", "id": "title", "label": "Slide Title", "default": "New Slide" },
        {
          "type": "textarea",
          "id": "description",
          "label": "Slide Description",
          "default": "Describe your promotion here"
        },
        { "type": "header", "content": "CTA Buttons" },
        { "type": "text", "id": "cta_text_1", "label": "CTA 1 Text" },
        { "type": "url", "id": "cta_link_1", "label": "CTA 1 Link" },
        { "type": "color", "id": "cta_color_1", "label": "CTA 1 Color", "default": "#000000" },
        { "type": "text", "id": "cta_text_2", "label": "CTA 2 Text" },
        { "type": "url", "id": "cta_link_2", "label": "CTA 2 Link" },
        { "type": "color", "id": "cta_color_2", "label": "CTA 2 Color", "default": "#000000" },
        { "type": "text", "id": "cta_text_3", "label": "CTA 3 Text" },
        { "type": "url", "id": "cta_link_3", "label": "CTA 3 Link" },
        { "type": "color", "id": "cta_color_3", "label": "CTA 3 Color", "default": "#000000" }
      ]
    }
  ]
}
{% endschema %}
