{%- comment -%}
  Image Slider Section
  Optimized for performance, accessibility, and theme editor integration
{%- endcomment -%}

{%- comment -%} Assets loaded conditionally via theme.liquid {%- endcomment -%}

{%- liquid
  comment
    Variable initialization with defensive defaults for theme editor
  endcomment
  assign slider_gap = section.settings.slide_gap | default: 16
  assign slider_padding = section.settings.section_padding | default: 32
  assign slider_blur = section.settings.blur_amount | default: 4
  assign slider_side_opacity = section.settings.side_opacity | default: 0.6
  assign slider_side_scale = section.settings.side_scale | default: 0.8
  assign slider_bg_image = section.settings.background_image
  assign slider_bg_opacity = section.settings.background_opacity | default: 0
  assign slider_bg_size = section.settings.background_tile_size | default: 150
  assign slider_autoplay = section.settings.enable_autoplay | default: false
  assign slider_interval = section.settings.autoplay_interval | default: 10
  assign slider_transition = section.settings.transition_duration | default: 1000
  assign slider_blocks_count = section.blocks.size | default: 0
  assign slider_nav_left_distance = section.settings.navigation_left_distance | default: 10
  assign slider_nav_right_distance = section.settings.navigation_right_distance | default: 10
  assign current_slide_index = section.settings.current_slide | default: 1
  
  comment
    Performance optimization: Preload first slide image for faster LCP
    Using Shopify's native preload_tag for better integration
  endcomment
  assign first_slide = section.blocks.first
  if first_slide and first_slide.settings.image != blank
    assign preload_desktop = first_slide.settings.image | image_url: width: 1920
    assign preload_mobile = first_slide.settings.image | image_url: width: 768
    echo preload_desktop | preload_tag: as: 'image', media: '(min-width: 768px)'
    echo preload_mobile | preload_tag: as: 'image', media: '(max-width: 767px)'
  endif
-%}

<section
  id="{{ slider_id }}"
  class="image-slider"
  role="region"
  aria-label="Image carousel with {{ slider_blocks_count }} slides"
  aria-roledescription="carousel"
  aria-live="polite"
  aria-describedby="{{ slider_id }}-instructions"
  data-section-type="image-slider"
  data-autoplay="{{ slider_autoplay }}"
  data-interval="{{ slider_interval | times: 1000 }}"
  style="
    --slider-transition-duration: {{ slider_transition }}ms;
    --slider-slide-spacing: {{ slider_gap }}px;
    --slider-section-padding: {{ slider_padding }}px;
    --slider-slide-blur: {{ slider_blur }}px;
    --slider-slide-opacity: {{ slider_side_opacity }};
    --slider-slide-scale: {{ slider_side_scale }};
    --slider-will-change: transform;
    --slider-content-visibility: auto;
    --slider-navigation-left-distance: {{ slider_nav_left_distance }}%;
    --slider-navigation-right-distance: {{ slider_nav_right_distance }}%;
    --slider-slide-count: {{ slider_blocks_count }};
    --slider-current-position: {{ current_slide_index }};
    {%- if slider_bg_image != blank -%}
      {%- comment -%} Background pattern optimized for tiling with high resolution {%- endcomment -%}
      --slider-background-image: url({{ slider_bg_image | image_url: width: 800 }});
      --slider-background-opacity: {{ slider_bg_opacity }};
      --slider-background-tile-size: {{ slider_bg_size }}px;
    {%- endif -%}
  "
>
  {%- comment -%} Hidden accessibility instructions {%- endcomment -%}
  <div id="{{ slider_id }}-instructions" class="visually-hidden">
    Use left and right arrow keys to navigate between slides. Touch devices can swipe left or right.
  </div>


  {%- comment -%} Wrapper with container query context for viewport-independent positioning {%- endcomment -%}
  <div class="image-slider__wrapper">
    {%- comment -%} Main slides container with fixed-width layout {%- endcomment -%}
    <div class="image-slider__container" 
         style="will-change: transform; transform: translateX(calc(var(--slider-current-position) * -100% / var(--slider-slide-count)))">
    {%- for block in section.blocks -%}
      {%- liquid
        comment
          Performance optimization: eager load first 3 slides, lazy load the rest
        endcomment
        assign is_priority_slide = false
        if forloop.index <= 3
          assign is_priority_slide = true
        endif
        
        assign slide_id = slider_id | append: '-slide-' | append: forloop.index
      -%}
      
      {%- comment -%} Individual slide with enhanced accessibility and performance {%- endcomment -%}
      <div 
        id="{{ slide_id }}"
        class="image-slider__slide" 
        {{ block.shopify_attributes }}
        role="group"
        aria-roledescription="slide"
        {% if forloop.index == 2 %}aria-current="true"{% endif %}
        aria-hidden="{% unless forloop.index == 2 %}true{% else %}false{% endunless %}"
        aria-label="Slide {{ forloop.index }} of {{ forloop.length }}{% if block.settings.title != blank %}: {{ block.settings.title | escape }}{% endif %}"
        style="{% unless is_priority_slide %}content-visibility: auto;{% endunless %}"
      >
        {%- if block.settings.image != blank -%}
          {%- comment -%} Progressive image loading with modern formats and optimized performance {%- endcomment -%}
          {%- liquid
            comment
              Loading strategy: eager for first slide, lazy for others
              Fetchpriority: high for first slide, auto for others
            endcomment
            assign loading_strategy = 'lazy'
            assign fetch_priority = 'auto'
            if forloop.first
              assign loading_strategy = 'eager'
              assign fetch_priority = 'high'
            elsif is_priority_slide
              assign fetch_priority = 'auto'
            else
              assign fetch_priority = 'low'
            endif
            
            assign image_alt = block.settings.image.alt | default: block.settings.title | default: 'Slide image' | escape
          -%}
          <figure class="image-slider__figure">
            <picture class="image-slider__picture">
              {%- comment -%} WebP format for modern browsers with mobile-first optimization {%- endcomment -%}
              <source
                type="image/webp"
                srcset="
                  {{ block.settings.image | image_url: width: 320, format: 'webp' }} 320w,
                  {{ block.settings.image | image_url: width: 480, format: 'webp' }} 480w,
                  {{ block.settings.image | image_url: width: 640, format: 'webp' }} 640w,
                  {{ block.settings.image | image_url: width: 768, format: 'webp' }} 768w,
                  {{ block.settings.image | image_url: width: 1024, format: 'webp' }} 1024w,
                  {{ block.settings.image | image_url: width: 1280, format: 'webp' }} 1280w,
                  {{ block.settings.image | image_url: width: 1536, format: 'webp' }} 1536w,
                  {{ block.settings.image | image_url: width: 1920, format: 'webp' }} 1920w,
                  {{ block.settings.image | image_url: width: 2400, format: 'webp' }} 2400w,
                  {{ block.settings.image | image_url: width: 2900, format: 'webp' }} 2900w"
                sizes="(max-width: 767px) 100vw, (max-width: 1279px) 90vw, 1450px">
              {%- comment -%} Fallback image with optimized loading and priority {%- endcomment -%}
              {{
                block.settings.image
                | image_url: width: 2900
                | image_tag: 
                  loading: loading_strategy,
                  fetchpriority: fetch_priority,
                  widths: '320, 480, 640, 768, 1024, 1280, 1536, 1920, 2400, 2900',
                  sizes: '(max-width: 767px) 100vw, (max-width: 1279px) 90vw, 1450px',
                  class: 'image-slider__image',
                  alt: image_alt
              }}
            </picture>
          </figure>
        {%- else -%}
          {%- comment -%} Fallback placeholder with accessible attributes {%- endcomment -%}
          <figure class="image-slider__figure image-slider__placeholder">
            {{ 'image' | placeholder_svg_tag: 'placeholder-svg', alt: 'Placeholder image for slide ' | append: forloop.index }}
            {%- if block.settings.title != blank -%}
              <figcaption class="visually-hidden">{{ block.settings.title | escape }}</figcaption>
            {%- endif -%}
          </figure>
        {%- endif -%}
        
        {%- comment -%} Render slide content using improved snippet {%- endcomment -%}
        {%- render 'snippet-section-image-slider-slide-content-overlay', block: block -%}
      </div>
    {%- endfor -%}
    </div>
    {%- comment -%} Navigation controls rendered below content with separator {%- endcomment -%}
    {%- render 'snippet-section-image-slider-navigation', 
      slider_id: slider_id, 
      blocks_count: slider_blocks_count 
    -%}
  </div>
</section>

{%- comment -%} JavaScript loaded conditionally via theme.liquid {%- endcomment -%}

{% schema %}
{
  "name": "Image Slider",
  "tag": "section",
  "class": "shopify-section--slider",
  "max_blocks": 10,
  "settings": [
    {
      "type": "header",
      "content": "Slider Behavior"
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_interval",
      "label": "Autoplay interval (seconds)",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 10
    },
    {
      "type": "range",
      "id": "transition_duration",
      "label": "Transition duration (ms)",
      "min": 100,
      "max": 3000,
      "step": 50,
      "default": 1000
    },

    /* --------  New Appearance group  -------- */
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "range",
      "id": "slide_gap",
      "label": "Gap between slides (px)",
      "min": 0,
      "max": 64,
      "step": 2,
      "default": 16
    },
    {
      "type": "range",
      "id": "section_padding",
      "label": "Padding above & below slider (px)",
      "min": 0,
      "max": 160,
      "step": 4,
      "default": 32
    },
    {
      "type": "range",
      "id": "blur_amount",
      "label": "Side‑slide blur (px)",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "side_opacity",
      "label": "Side‑slide opacity (0 – 1)",
      "min": 0.1,
      "max": 1,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "side_scale",
      "label": "Side‑slide scale (0.5 – 1)",
      "min": 0.5,
      "max": 1,
      "step": 0.1,
      "default": 0.8
    },
    /* ---------- Background ---------- */
    {
      "type": "header",
      "content": "Background Pattern"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background tile image"
    },
    {
      "type": "range",
      "id": "background_opacity",
      "label": "Background opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0.1
    },
    {
      "type": "range",
      "id": "background_tile_size",
      "label": "Background tile size (px)",
      "min": 50,
      "max": 500,
      "step": 10,
      "default": 150
    },
    /* ---------- Navigation ---------- */
    {
      "type": "header",
      "content": "Navigation Positioning"
    },
    {
      "type": "range",
      "id": "navigation_left_distance",
      "label": "Left distance (%)",
      "min": 0,
      "max": 25,
      "step": 1,
      "default": 10
    },
    {
      "type": "range",
      "id": "navigation_right_distance", 
      "label": "Right distance (%)",
      "min": 0,
      "max": 25,
      "step": 1,
      "default": 10
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Slide Image" },
        { "type": "text", "id": "title", "label": "Slide Title", "default": "New Slide" },
        {
          "type": "textarea",
          "id": "description",
          "label": "Slide Description",
          "default": "Describe your promotion here"
        },
        { "type": "header", "content": "CTA Buttons" },
        { "type": "text", "id": "cta_text_1", "label": "CTA 1 Text" },
        { "type": "url", "id": "cta_link_1", "label": "CTA 1 Link" },
        { "type": "color", "id": "cta_color_1", "label": "CTA 1 Color", "default": "#000000" },
        { "type": "text", "id": "cta_text_2", "label": "CTA 2 Text" },
        { "type": "url", "id": "cta_link_2", "label": "CTA 2 Link" },
        { "type": "color", "id": "cta_color_2", "label": "CTA 2 Color", "default": "#000000" },
        { "type": "text", "id": "cta_text_3", "label": "CTA 3 Text" },
        { "type": "url", "id": "cta_link_3", "label": "CTA 3 Link" },
        { "type": "color", "id": "cta_color_3", "label": "CTA 3 Color", "default": "#000000" }
      ]
    }
  ]
}
{% endschema %}
