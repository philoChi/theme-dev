{%- comment -%}
  Section: Collection Page
  Purpose: Main collection display with product grid (Webpack Bundled)
  Version: 3.0 - Now using webpack bundling for optimized performance

  Benefits of webpack bundling:
  - Single HTTP request for all collection page JavaScript
  - Tree shaking removes unused code
  - Better caching with webpack hashing
  - Modular development with nested folder structure
  - Code splitting for shared utilities
{%- endcomment -%}

{%- liquid
  # Detect context - search or collection
  assign is_search_context = false
  if template contains 'search'
    assign is_search_context = true
  endif

  # Get data based on context
  if is_search_context
    assign search_performed = false
    if search.terms != blank
      assign search_performed = true
    endif
  else
    assign collection = collections[section.settings.collection] | default: collection
  endif

  # Grid configuration
  assign desktop_columns = section.settings.desktop_columns | default: 4
  assign tablet_columns = section.settings.tablet_columns | default: 2
  assign mobile_columns = section.settings.mobile_columns | default: 1
  assign products_per_page = section.settings.products_per_page | default: 40

  # Simplified grid classes
  assign grid_classes = 'collection-grid'
  assign grid_classes = grid_classes | append: ' collection-grid--desktop-' | append: desktop_columns
  assign grid_classes = grid_classes | append: ' collection-grid--tablet-' | append: tablet_columns
  assign grid_classes = grid_classes | append: ' collection-grid--mobile-' | append: mobile_columns
  if is_search_context
    assign grid_classes = grid_classes | append: ' collection-grid--search'
  endif

  # Determine if we should show toolbar
  assign show_toolbar = true
  if is_search_context and search_performed == false
    assign show_toolbar = false
  elsif is_search_context and search.results_count == 0
    assign show_toolbar = false
  endif
-%}

<section
  class="section-collection-page collection-page-bundle{% if is_search_context %} section-search-results{% endif %}"
  data-section-id="{{ section.id }}"
  data-section-type="{% if is_search_context %}search-results{% else %}collection{% endif %}"
  data-show-filter-counts="{{ section.settings.show_filter_counts }}"
  data-default-sort="{{ section.settings.default_sort_order }}"
  data-products-per-page="{{ products_per_page }}"
  data-bundle-version="true"
>
  <div class="collection-page__container">
    {%- # Header - Collection or Search -%}
    {% render 'snippet-section-page-collections-main-header',
      is_search: is_search_context,
      collection: collection,
      search: search,
      search_performed: search_performed,
      show_product_count: section.settings.show_product_count
    %}

    {%- # Toolbar (filters and sorting) - Show only if we have results -%}
    {%- if show_toolbar -%}
      {% render 'snippet-section-page-collections-main-toolbar',
        is_search: is_search_context,
        section_id: section.id,
        settings: section.settings
      %}
    {%- endif -%}

    {%- # Active Filters Display -%}
    {%- if show_toolbar -%}
      {% render 'snippet-section-page-collections-main-active-filters',
        collection: collection,
        show_clear_all: true
      %}
    {%- endif -%}

    {%- # Subtle separator between toolbar and products -%}
    <div class="collection-page__separator" aria-hidden="true"></div>

    {%- # Product Grid -%}
    {% render 'snippet-section-page-collections-main-grid',
      is_search: is_search_context,
      collection: collection,
      search: search,
      search_performed: search_performed,
      products_per_page: products_per_page,
      grid_classes: grid_classes,
      section_id: section.id,
      settings: section.settings
    %}
  </div>
</section>

{%- # Theme strings for collection functionality -%}
<script>
  window.themeStrings = window.themeStrings || {};
  window.themeStrings.products = {{ 'products.general.products' | t | json }};
  window.themeStrings.showing = {{ 'collections.pagination.showing' | t | json }};
</script>

{%- # Preconnect to improve image loading performance -%}
{%- unless is_search_context -%}
  {%- if collection.products.size > 0 -%}
    <link rel="preconnect" href="https://cdn.shopify.com">
  {%- endif -%}
{%- endunless -%}

{% schema %}
{
  "name": "Collection page",
  "tag": "section",
  "class": "section-collection-page-wrapper",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "desktop_columns",
      "label": "Desktop columns",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "tablet_columns",
      "label": "Tablet columns",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "select",
      "id": "mobile_columns",
      "label": "Mobile columns",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "1"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 12,
      "max": 48,
      "step": 12,
      "default": 24
    },
    {
      "type": "header",
      "content": "Features"
    },
    {
      "type": "checkbox",
      "id": "show_product_count",
      "label": "Show product count",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Enable sorting",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_filters_on_mobile",
      "label": "Show filter button on mobile",
      "default": true
    },
    {
      "type": "header",
      "content": "Customization"
    },
    {
      "type": "text",
      "id": "custom_filter_label",
      "label": "Custom filter button label",
      "default": "Filter",
      "info": "Custom text for the filter button (mobile)"
    },
    {
      "type": "text",
      "id": "custom_empty_message",
      "label": "Custom empty collection message",
      "default": "Keine Produkte gefunden",
      "info": "Message shown when no products match filters"
    },
    {
      "type": "checkbox",
      "id": "show_filter_counts",
      "label": "Show filter option counts",
      "default": true,
      "info": "Display product counts next to filter options"
    },
    {
      "type": "select",
      "id": "default_sort_order",
      "label": "Default sort order",
      "options": [
        {
          "value": "manual",
          "label": "Featured"
        },
        {
          "value": "created-descending",
          "label": "Newest first"
        },
        {
          "value": "price-ascending",
          "label": "Price: Low to high"
        },
        {
          "value": "price-descending",
          "label": "Price: High to low"
        },
        {
          "value": "best-selling",
          "label": "Best selling"
        }
      ],
      "default": "manual"
    }
  ],
  "presets": [
    {
      "name": "Collection page",
      "settings": {
        "desktop_columns": 4,
        "tablet_columns": 2,
        "mobile_columns": "1",
        "products_per_page": 24,
        "show_product_count": true,
        "enable_filtering": true,
        "enable_sorting": true,
        "show_filters_on_mobile": true,
        "show_filter_counts": true,
        "default_sort_order": "manual"
      }
    }
  ]
}
{% endschema %}
